<ion-split-pane contentId="home-content" when="lg">
  <ion-menu contentId="home-content" type="overlay">
    <ion-content class="sidebar">
      <div class="brand">
        <div class="brand-icon">
          <ion-icon name="storefront"></ion-icon>
        </div>
        <div class="brand-info">
          <div class="brand-name">SMARTPOS</div>
          <div class="brand-sub">PRO</div>
        </div>
      </div>
      <ion-list lines="none">
        <ion-item button [class.active]="currentView === 'dashboard'" (click)="setView('dashboard')" title="Inicio"
          aria-label="Inicio">
          <ion-icon slot="start" name="home-outline"></ion-icon>
          <ion-label>Dashboard</ion-label>
        </ion-item>

        @if (hasModule('inventario') || hasModule('productos') || hasPermission('VER_INVENTARIO')) {
        <ion-item button [class.active]="currentView === 'productos'" (click)="setView('productos')" title="Productos"
          aria-label="Productos">
          <ion-icon slot="start" name="cube-outline"></ion-icon>
          <ion-label>Productos</ion-label>
        </ion-item>
        }

        @if (hasModule('ventas') || hasPermission('VENDER') || hasPermission('VER_VENTAS')) {
        <ion-item button [class.active]="currentView === 'ventas'" (click)="setView('ventas')" title="Ventas"
          aria-label="Ventas">
          <ion-icon slot="start" name="cart-outline"></ion-icon>
          <ion-label>Ventas</ion-label>
        </ion-item>
        }

        @if (hasModule('usuarios') || hasPermission('VER_USUARIOS')) {
        <ion-item button [class.active]="currentView === 'users'" (click)="setView('users')" title="Usuarios"
          aria-label="Usuarios">
          <ion-icon slot="start" name="people-circle-outline"></ion-icon>
          <ion-label>Usuarios</ion-label>
        </ion-item>
        }

        @if (hasModule('clientes') || hasPermission('VER_CLIENTES')) {
        <ion-item button [class.active]="currentView === 'clientes'" (click)="setView('clientes')" title="Clientes"
          aria-label="Clientes">
          <ion-icon slot="start" name="people-outline"></ion-icon>
          <ion-label>Clientes</ion-label>
        </ion-item>
        }

        @if (hasModule('modulos') || hasPermission('GESTION_MODULOS')) {
        <ion-item button [class.active]="currentView === 'modulos'" (click)="setView('modulos')" title="Módulos"
          aria-label="Módulos">
          <ion-icon slot="start" name="grid-outline"></ion-icon>
          <ion-label>Módulos</ion-label>
        </ion-item>
        }

        @if (hasModule('finanzas') || hasPermission('VER_FINANZAS')) {
        <ion-item button [class.active]="currentView === 'finanzas'" (click)="setView('finanzas')" title="Finanzas"
          aria-label="Finanzas">
          <ion-icon slot="start" name="cash-outline"></ion-icon>
          <ion-label>Finanzas</ion-label>
        </ion-item>
        }

        @if (hasModule('reportes') || hasPermission('VER_REPORTES')) {
        <ion-item button [class.active]="currentView === 'reportes'" (click)="setView('reportes')" title="Reportes"
          aria-label="Reportes">
          <ion-icon slot="start" name="bar-chart-outline"></ion-icon>
          <ion-label>Reportes</ion-label>
        </ion-item>
        }

        @if (hasModule('configuracion') || hasPermission('VER_CONFIGURACION')) {
        <ion-item button [class.active]="currentView === 'configuracion'" (click)="setView('configuracion')"
          title="Configuración" aria-label="Configuración">
          <ion-icon slot="start" name="settings-outline"></ion-icon>
          <ion-label>Configuración</ion-label>
        </ion-item>
        }
      </ion-list>
    </ion-content>
  </ion-menu>

  <ion-content id="home-content" [fullscreen]="true" class="dashboard">
    <ion-header class="topbar" [translucent]="false">
      <ion-toolbar style="--background: #134e4a; --color: white;">
        <!-- Dark teal/green hardcoded for safety against 'dark' attribute -->
        <ion-buttons slot="start">
          <ion-menu-button></ion-menu-button>
        </ion-buttons>
        <ion-title>{{ pageTitle }}</ion-title>
        <ion-buttons slot="end">


          <ion-button id="notifications-trigger" aria-label="Notificaciones" class="notification-btn">
            <ion-icon name="notifications-outline"></ion-icon>
            @if ((unreadCount$ | async); as count) {
            <ion-badge color="danger" class="notification-badge">
              {{ count > 9 ? '9+' : count }}
            </ion-badge>
            }
          </ion-button>

          <ion-popover trigger="notifications-trigger" dismissOnSelect="true" class="notification-popover" side="bottom"
            alignment="end" [showBackdrop]="false">
            <ng-template>
              <div class="notification-container">
                <div class="notification-header">
                  <h3>Notificaciones</h3>
                  <ion-button fill="clear" size="small" (click)="markAllRead()"
                    [disabled]="(unreadCount$ | async) === 0">
                    Marcar leídas
                  </ion-button>
                </div>

                <div class="notification-list-wrapper">
                  <ion-list lines="full" class="ion-no-padding">
                    @for (n of notifications$ | async; track n) {
                    <ion-item button [class.unread]="!n.read" (click)="markAsRead(n)" detail="false"
                      class="notification-item">
                      <div class="notif-icon-wrapper" slot="start" [class]="n.type">
                        <ion-icon [name]="getIconForType(n.type)"></ion-icon>
                      </div>
                      <ion-label class="ion-text-wrap">
                        <div class="notif-top">
                          <span class="notif-title">{{ n.title }}</span>
                          <span class="notif-time">{{ n.timestamp | date:'shortTime' }}</span>
                        </div>
                        <p class="notif-msg">{{ n.message }}</p>
                      </ion-label>
                      <ion-button slot="end" fill="clear" color="medium" size="small"
                        (click)="removeNotification($event, n.id)">
                        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                    </ion-item>
                    }

                    @if ((notifications$ | async)?.length === 0) {
                    <div class="empty-notifications">
                      <div class="empty-icon-wrapper">
                        <ion-icon name="notifications-off-outline"></ion-icon>
                      </div>
                      <h4>Todo al día</h4>
                      <p>No tienes notificaciones pendientes por ahora.</p>
                    </div>
                    }
                  </ion-list>
                </div>
              </div>
            </ng-template>
          </ion-popover>

          <div class="user-profile-widget">
            @if (currentUser) {
            <div class="user-details">
              <span class="user-name">{{ currentUser.nombre }}</span>
              <span class="user-role">{{ currentUser.roles[0] || 'Usuario' }}</span>
            </div>
            <div class="user-avatar">
              <span>{{ currentUser.nombre.charAt(0).toUpperCase() }}</span>
            </div>
            } @else {
            <div class="user-details" style="opacity: 0.5;">
              <span class="user-name">Cargando...</span>
            </div>
            <div class="user-avatar" style="background: #e0e0e0;">
              <ion-spinner name="dots" color="primary" style="transform: scale(0.5);"></ion-spinner>
            </div>
            }


            <ion-button fill="clear" class="logout-btn" (click)="logout()" title="Cerrar Sesión">
              <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <div class="content-container">
      @if (currentView === 'dashboard') {
      <app-dashboard (navigate)="setView($event)"></app-dashboard>
      }
      @if (currentView === 'users') {
      <app-users></app-users>
      }
      @if (currentView === 'ventas') {
      <app-ventas></app-ventas>
      }
      @if (currentView === 'productos') {
      <app-productos></app-productos>
      }
      @if (currentView === 'clientes') {
      <app-clientes></app-clientes>
      }
      @if (currentView === 'modulos') {
      <app-modulos></app-modulos>
      }
      @if (currentView === 'finanzas') {
      <app-finanzas></app-finanzas>
      }
      @if (currentView === 'reportes') {
      <app-reportes></app-reportes>
      }
      @if (currentView === 'configuracion') {
      <app-configuracion></app-configuracion>
      }
    </div>

    <div class="mobile-tabbar" role="tablist" aria-label="Navegación inferior">
      <button class="item" [class.active]="currentView === 'dashboard'" (click)="setView('dashboard')" role="tab"
        [attr.aria-selected]="currentView === 'dashboard'">
        <ion-icon name="home-outline"></ion-icon>
        <span>Inicio</span>
      </button>

      @if (hasModule('inventario') || hasModule('productos') || hasPermission('VER_INVENTARIO') ||
      hasPermission('ADMIN')) {
      <button class="item" [class.active]="currentView === 'productos'" (click)="setView('productos')" role="tab"
        [attr.aria-selected]="currentView === 'productos'">
        <ion-icon name="cube-outline"></ion-icon>
        <span>Prod.</span>
      </button>
      }

      @if (hasModule('ventas') || hasPermission('VENDER') || hasPermission('VER_VENTAS') || hasPermission('ADMIN')) {
      <button class="item" [class.active]="currentView === 'ventas'" (click)="setView('ventas')" role="tab"
        [attr.aria-selected]="currentView === 'ventas'">
        <ion-icon name="cart-outline"></ion-icon>
        <span>Ventas</span>
      </button>
      }

      @if (hasModule('usuarios') || hasPermission('VER_USUARIOS') || hasPermission('ADMIN')) {
      <button class="item" [class.active]="currentView === 'users'" (click)="setView('users')" role="tab"
        [attr.aria-selected]="currentView === 'users'">
        <ion-icon name="people-circle-outline"></ion-icon>
        <span>Users</span>
      </button>
      }

      @if (hasModule('clientes') || hasPermission('VER_CLIENTES') || hasPermission('ADMIN')) {
      <button class="item" [class.active]="currentView === 'clientes'" (click)="setView('clientes')" role="tab"
        [attr.aria-selected]="currentView === 'clientes'">
        <ion-icon name="people-outline"></ion-icon>
        <span>Clientes</span>
      </button>
      }

      @if (hasModule('modulos') || hasPermission('GESTION_MODULOS') || hasPermission('ADMIN')) {
      <button class="item" [class.active]="currentView === 'modulos'" (click)="setView('modulos')" role="tab"
        [attr.aria-selected]="currentView === 'modulos'">
        <ion-icon name="grid-outline"></ion-icon>
        <span>Módulos</span>
      </button>
      }

      @if (hasModule('finanzas') || hasPermission('VER_FINANZAS') || hasPermission('ADMIN')) {
      <button class="item" [class.active]="currentView === 'finanzas'" (click)="setView('finanzas')" role="tab"
        [attr.aria-selected]="currentView === 'finanzas'">
        <ion-icon name="cash-outline"></ion-icon>
        <span>Finanzas</span>
      </button>
      }

      @if (hasModule('reportes') || hasPermission('VER_REPORTES') || hasPermission('ADMIN')) {
      <button class="item" [class.active]="currentView === 'reportes'" (click)="setView('reportes')" role="tab"
        [attr.aria-selected]="currentView === 'reportes'">
        <ion-icon name="bar-chart-outline"></ion-icon>
        <span>Reportes</span>
      </button>
      }

      @if (hasModule('configuracion') || hasPermission('VER_CONFIGURACION') || hasPermission('ADMIN')) {
      <button class="item" role="tab" [class.active]="currentView === 'configuracion'"
        (click)="setView('configuracion')" [attr.aria-selected]="currentView === 'configuracion'">
        <ion-icon name="settings-outline"></ion-icon>
        <span>Config.</span>
      </button>
      }
    </div>
  </ion-content>
</ion-split-pane>