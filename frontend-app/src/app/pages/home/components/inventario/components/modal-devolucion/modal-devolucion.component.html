<div class="modal-container">
    <div class="modal-header">
        <h2>Registrar Devolución</h2>
        <ion-button fill="clear" color="medium" (click)="cerrar()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
        </ion-button>
    </div>

    <div class="modal-content">

        <div class="search-section" *ngIf="!venta">
            <input type="number" placeholder="Ingrese ID de Venta" [(ngModel)]="searchId" (keyup.enter)="buscarVenta()">
            <ion-button (click)="buscarVenta()" [disabled]="isLoading">
                <ion-icon name="search"></ion-icon>
            </ion-button>
        </div>

        <div *ngIf="venta">
            <div class="sale-info">
                <div class="row">
                    <label>Venta #</label>
                    <span>{{ venta.id }}</span>
                </div>
                <div class="row">
                    <label>Fecha</label>
                    <span>{{ venta.fecha | date:'medium' }}</span>
                </div>
                <div class="row">
                    <label>Cliente</label>
                    <span>{{ venta.cliente?.nombre || 'General' }}</span>
                </div>
                <div class="row">
                    <label>Estado Pago</label>
                    <span>{{ venta.estadoPago }}</span>
                </div>
                <br>
                <ion-button size="small" fill="outline" color="danger" (click)="reset()">Cambiar Venta</ion-button>
            </div>

            <h3 style="font-size: 1rem; margin-bottom: 1rem;">Seleccione ítems a devolver:</h3>

            <div class="items-list">
                @for (item of itemsDevolucion; track item.productoId) {
                <div class="item-card" [class.selected]="item.cantidad > 0">
                    <div class="info">
                        <span class="name">{{ item.nombreProducto }}</span>
                        <span class="sku" *ngIf="item.sku">SKU: {{ item.sku }}</span>
                        <span class="price">Precio Venta: ${{ item.precioUnitario | number }}</span>
                    </div>

                    <div class="controls">
                        <span class="limit">Comprado: <strong>{{ item.cantidadComprada }}</strong> de {{
                            item.cantidadComprada }}</span>

                        <div class="qty-control">
                            <ion-button size="small" fill="clear" (click)="decrementar(item)">
                                <ion-icon name="remove-circle-outline"></ion-icon>
                            </ion-button>
                            <input type="number" [(ngModel)]="item.cantidad" min="0" [max]="item.cantidadComprada">
                            <ion-button size="small" fill="clear" (click)="incrementar(item)">
                                <ion-icon name="add-circle-outline"></ion-icon>
                            </ion-button>
                        </div>
                    </div>
                </div>
                }
            </div>

            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Motivo de la devolución</label>
                <textarea style="width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px;" rows="3"
                    placeholder="Explique la razón..." [(ngModel)]="motivo"></textarea>
            </div>

            <div class="summary"
                style="background: #ecfdf5; padding: 1rem; border-radius: 12px; border: 1px solid #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #047857; font-weight: 600;">Total a Devolver:</span>
                    <span style="font-size: 1.25rem; font-weight: 700; color: #047857;">${{ calcularTotal() | number
                        }}</span>
                </div>
            </div>
        </div>

    </div>

    <div class="footer" *ngIf="venta">
        <ion-button fill="outline" color="medium" (click)="cerrar()">Cancelar</ion-button>
        <ion-button color="danger" [disabled]="calcularTotal() === 0 || !motivo || isSubmitting"
            (click)="confirmarDevolucion()">
            <span *ngIf="!isSubmitting">Confirmar Devolución</span>
            <ion-spinner *ngIf="isSubmitting"></ion-spinner>
        </ion-button>
    </div>
</div>