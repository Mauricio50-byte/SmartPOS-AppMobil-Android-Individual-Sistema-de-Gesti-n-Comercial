<div class="dashboard-container">
  @if (dataLoaded) {
  <div class="grid-layout">

    <!-- Panel de Métricas Rápidas (Siempre visible arriba) -->
    <div class="panel-area metrics-area">
      <div class="metrics-grid">
        @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
        <div class="metric-card">
          <div class="metric-icon-wrapper income">
            <ion-icon name="cash-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ totalIngresos | currency:'USD':'symbol':'1.0-0' }}</div>
            <div class="metric-label">Ingresos Totales</div>
            <div class="metric-trend positive">
              <ion-icon name="trending-up-outline"></ion-icon> <span>+12%</span>
            </div>
          </div>
        </div>
        }

        @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
        <div class="metric-card">
          <div class="metric-icon-wrapper sales">
            <ion-icon name="cart-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ totalVentas }}</div>
            <div class="metric-label">Ventas Totales</div>
            <div class="metric-trend positive">
              <ion-icon name="trending-up-outline"></ion-icon> <span>+5%</span>
            </div>
          </div>
        </div>
        }

        @if (canAccess('VER_CLIENTES')) {
        <div class="metric-card">
          <div class="metric-icon-wrapper clients">
            <ion-icon name="people-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ nuevosClientes }}</div>
            <div class="metric-label">Clientes Nuevos</div>
            <div class="metric-trend neutral">
              <ion-icon name="remove-outline"></ion-icon> <span>=</span>
            </div>
          </div>
        </div>
        }

        @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
        <div class="metric-card">
          <div class="metric-icon-wrapper ticket">
            <ion-icon name="pricetags-outline"></ion-icon>
          </div>
          <div class="metric-info">
            <div class="metric-value">{{ ticketPromedio | currency:'USD':'symbol':'1.0-0' }}</div>
            <div class="metric-label">Ticket Promedio</div>
            <div class="metric-trend positive">
              <ion-icon name="trending-up-outline"></ion-icon> <span>+2%</span>
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Panel de Ventas Mensuales (Principal) -->
    @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
    <div class="panel-card sales-chart-area">
      <div class="panel-header">
        <div class="header-info">
          <h3 class="panel-title">Ventas Mensuales</h3>
          <span class="panel-subtitle">Comportamiento anual</span>
        </div>
        <div class="filter-control">
          <ion-select [value]="timeFilter" (ionChange)="onFilterChange($event)" interface="popover">
            <ion-select-option value="week">Semana</ion-select-option>
            <ion-select-option value="month">Mes</ion-select-option>
            <ion-select-option value="year">Año</ion-select-option>
          </ion-select>
        </div>
      </div>
      <div class="panel-content chart-wrapper">
        @if (ventasChartData) {
        <div class="chart-container">
          <canvas baseChart [data]="ventasChartData" [options]="barChartOptions" [type]="barChartType">
          </canvas>
        </div>
        }
      </div>
    </div>
    }

    <!-- Panel de Acciones Rápidas -->
    <div class="panel-card actions-area">
      <div class="panel-header">
        <h3 class="panel-title">Acciones</h3>
      </div>
      <div class="panel-content actions-grid">
        @if (canAccess('CREAR_VENTA') || canAccess('VENDER')) {
        <ion-button class="action-btn" color="primary" (click)="onNavigate('ventas')">
          <div class="btn-content">
            <ion-icon name="add-circle-outline"></ion-icon>
            <span>Venta</span>
          </div>
        </ion-button>
        }
        @if (canAccess('VER_INVENTARIO')) {
        <ion-button class="action-btn" color="secondary" (click)="onNavigate('productos')">
          <div class="btn-content">
            <ion-icon name="cube-outline"></ion-icon>
            <span>Productos</span>
          </div>
        </ion-button>
        }
        @if (canAccess('CREAR_CLIENTE')) {
        <ion-button class="action-btn" color="tertiary" (click)="onNavigate('clientes')">
          <div class="btn-content">
            <ion-icon name="person-add-outline"></ion-icon>
            <span>Cliente</span>
          </div>
        </ion-button>
        }
        @if (canAccess('VER_FINANZAS')) {
        <ion-button class="action-btn" color="medium" (click)="onNavigate('finanzas')">
          <div class="btn-content">
            <ion-icon name="wallet-outline"></ion-icon>
            <span>Finanzas</span>
          </div>
        </ion-button>
        }
      </div>
    </div>

    <!-- Transacciones Recientes -->
    @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
    <div class="panel-card transactions-area">
      <div class="panel-header">
        <h3 class="panel-title">Recientes</h3>
        <span class="panel-subtitle">Últimas 5 ventas</span>
      </div>
      <div class="panel-content table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Total</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            @for (venta of recentTransactions; track venta) {
            <tr>
              <td data-label="ID">#{{ venta.id }}</td>
              <td data-label="Fecha">{{ venta.fecha | date:'shortDate' }}</td>
              <td data-label="Total" class="amount">{{ venta.total | currency:'USD':'symbol':'1.0-0' }}</td>
              <td data-label="Estado">
                <span class="status-badge success">Ok</span>
              </td>
            </tr>
            }
            @if (recentTransactions.length === 0) {
            <tr>
              <td colspan="4" class="empty-text">Sin transacciones</td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    }

    <!-- Alertas de Stock Bajo -->
    @if (canAccess('VER_INVENTARIO')) {
    <div class="panel-card low-stock-area">
      <div class="panel-header">
        <h3 class="panel-title">Stock Bajo</h3>
        @if (lowStockProducts.length > 0) {
        <span class="panel-subtitle">Atención requerida</span>
        }
      </div>
      <div class="panel-content list-container">
        @if (lowStockProducts.length > 0) {
        <div class="stock-list">
          @for (p of lowStockProducts; track p) {
          <div class="stock-item">
            <div class="stock-info">
              <div class="stock-name">{{ p.nombre }}</div>
              <div class="stock-meta">Min: {{ p.stockMinimo || 5 }}</div>
            </div>
            <div class="stock-badge warning">
              {{ p.stock }} unids.
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="empty-state">
          <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
          <span>Inventario Saludable</span>
        </div>
        }
      </div>
    </div>
    }

    <!-- Panel de Productos Más Vendidos -->
    @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
    <div class="panel-card top-products-area">
      <div class="panel-header">
        <h3 class="panel-title">Top Productos</h3>
      </div>
      <div class="panel-content list-container">
        @if (topProducts.length > 0) {
        <div class="top-product-list">
          @for (p of topProducts; track p; let i = $index) {
          <div class="top-product-item">
            <div class="rank-badge">{{ i + 1 }}</div>
            <div class="product-details">
              <div class="product-name">{{ p.name }}</div>
              <div class="product-bar-bg">
                <div class="product-bar-fill" [style.width.%]="p.percentage"></div>
              </div>
            </div>
            <div class="product-stats">
              <div class="stat-qty">{{ p.qty }}</div>
              <div class="stat-label">vendidos</div>
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="empty-state">
          <ion-icon name="stats-chart-outline"></ion-icon>
          <span>Sin datos de ventas</span>
        </div>
        }
      </div>
    </div>
    }

    <!-- Paneles Distribución (Categoría y Pagos) -->
    @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
    <div class="panel-card category-area">
      <app-category-distribution [ventas]="allVentas" [productos]="allProductos">
      </app-category-distribution>
    </div>
    }

    @if (canAccess('VER_VENTAS') || canAccess('VENDER')) {
    <div class="panel-card payment-area">
      <app-payment-distribution [ventas]="allVentas">
      </app-payment-distribution>
    </div>
    }

    <!-- Panel de Mejores Clientes -->
    @if ((canAccess('VER_VENTAS') || canAccess('VENDER')) && canAccess('VER_CLIENTES')) {
    <div class="panel-card customers-area">
      <app-top-customers [ventas]="allVentas" [clientes]="allClientes">
      </app-top-customers>
    </div>
    }

  </div>
  } @else {
  <!-- SKELETON LOADER -->
  <div class="grid-layout">
    <!-- Skeleton Métricas -->
    <div class="panel-area metrics-area">
      <div class="metrics-grid">
        <div class="metric-card" *ngFor="let i of [1,2,3,4]">
          <div class="metric-icon-wrapper" style="background: #f3f4f6;">
            <ion-skeleton-text animated style="width: 100%; height: 100%; border-radius: 12px;"></ion-skeleton-text>
          </div>
          <div class="metric-info" style="width: 100%; padding-left: 16px;">
            <ion-skeleton-text animated style="width: 60%; height: 2rem; margin-bottom: 4px; border-radius: 4px;">
            </ion-skeleton-text>
            <ion-skeleton-text animated style="width: 40%; height: 1rem; border-radius: 4px;"></ion-skeleton-text>
          </div>
        </div>
      </div>
    </div>

    <!-- Skeleton Chart -->
    <div class="panel-card sales-chart-area">
      <div class="panel-header">
        <ion-skeleton-text animated style="width: 150px; height: 20px; border-radius: 4px;"></ion-skeleton-text>
      </div>
      <div class="panel-content chart-wrapper" style="display: block;">
        <ion-skeleton-text animated style="width: 100%; height: 200px; border-radius: 8px; margin-top: 20px;">
        </ion-skeleton-text>
      </div>
    </div>

    <!-- Skeleton Actions -->
    <div class="panel-card actions-area">
      <div class="panel-header">
        <ion-skeleton-text animated style="width: 100px; height: 20px; border-radius: 4px;"></ion-skeleton-text>
      </div>
      <div class="panel-content actions-grid">
        <div class="action-btn-skeleton" *ngFor="let i of [1,2,3,4]" style="height: 50px;">
          <ion-skeleton-text animated style="width: 100%; height: 100%; border-radius: 12px;"></ion-skeleton-text>
        </div>
      </div>
    </div>

    <!-- Skeleton Recientes -->
    <div class="panel-card transactions-area">
      <div class="panel-header">
        <ion-skeleton-text animated style="width: 100px; height: 20px; border-radius: 4px;"></ion-skeleton-text>
      </div>
      <div class="panel-content">
        <div style="padding: 0 16px;">
          <ion-skeleton-text animated *ngFor="let i of [1,2,3]"
            style="width: 100%; height: 40px; margin-bottom: 12px; border-radius: 4px;"></ion-skeleton-text>
        </div>
      </div>
    </div>

    <!-- Skeleton Stock Bajo -->
    <div class="panel-card low-stock-area">
      <div class="panel-header">
        <ion-skeleton-text animated style="width: 100px; height: 20px; border-radius: 4px;"></ion-skeleton-text>
      </div>
      <div class="panel-content">
        <div style="padding: 0 16px;">
          <ion-skeleton-text animated *ngFor="let i of [1,2,3]"
            style="width: 100%; height: 40px; margin-bottom: 12px; border-radius: 4px;"></ion-skeleton-text>
        </div>
      </div>
    </div>
  </div>
  }
</div>