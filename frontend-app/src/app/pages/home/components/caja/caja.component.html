<div class="caja-content-wrapper ion-padding-horizontal">
  <div class="header-section">
    <div class="header-flex">
      <div class="title-group">
        <h1>Gestión de Caja</h1>
        <p class="subtitle">Control diario de flujo de efectivo</p>
      </div>
      <ion-button fill="clear" (click)="cargarEstadoCaja()" class="refresh-btn">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </div>

  @if (loading) {
  <div class="loading-state">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando información de caja...</p>
  </div>
  }

  @if (!loading && !caja) {
  <div class="closed-caja-container">
    <ion-card class="welcome-card ion-no-margin">
      <div class="card-status-icon">
        <ion-icon name="lock-closed"></ion-icon>
      </div>
      <ion-card-header>
        <ion-card-title>Caja Cerrada</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>Para comenzar a registrar ventas e ingresos, es necesario iniciar un nuevo turno de caja.</p>
        <ion-button expand="block" (click)="abrirCaja()" class="main-action-btn mt-6">
          <ion-icon name="key-outline" slot="start"></ion-icon>
          Abrir Nueva Caja
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>
  }

  @if (!loading && caja) {
  <div class="active-caja-layout">
    <!-- KPI Grid -->
    <div class="kpi-grid">
      <div class="kpi-card balance">
        <span class="kpi-label">Saldo Total</span>
        <span class="kpi-value">{{ caja.resumen?.saldoActual | currency }}</span>
        <div class="kpi-subdetails">
          <span class="chip-mini">Efectivo: {{ caja.resumen?.saldoEfectivo | currency }}</span>
          <span class="chip-mini">Transf: {{ saldoTransferencia | currency }}</span>
        </div>
      </div>

      <div class="kpi-card income">
        <span class="kpi-label">Ingresos</span>
        <span class="kpi-value success-text">{{ caja.resumen?.totalIngresos | currency }}</span>
      </div>

      <div class="kpi-card expense">
        <span class="kpi-label">Egresos</span>
        <span class="kpi-value danger-text">{{ caja.resumen?.totalEgresos | currency }}</span>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions-group">
      <ion-button color="success" (click)="registrarMovimiento('INGRESO')" class="action-btn">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Ingreso
      </ion-button>
      <ion-button color="danger" (click)="registrarMovimiento('EGRESO')" class="action-btn">
        <ion-icon name="remove-circle-outline" slot="start"></ion-icon>
        Egreso
      </ion-button>
      <ion-button color="dark" fill="outline" (click)="cerrarCaja()" class="action-btn">
        <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
        Cerrar Turno
      </ion-button>
    </div>

    <!-- Movements Section -->
    <div class="movements-section">
      <div class="section-header">
        <h3>Movimientos del Turno</h3>
        <span class="movements-count">{{ movimientos.length }} registros</span>
      </div>

      <!-- Desktop Table View -->
      <div class="table-container ion-hide-sm-down">
        <table class="custom-table">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Tipo</th>
              <th>Método</th>
              <th>Descripción</th>
              <th class="ion-text-end">Monto</th>
            </tr>
          </thead>
          <tbody>
            @for (mov of movimientos; track mov) {
            <tr>
              <td class="time-col">{{ mov.fecha | date:'shortTime' }}</td>
              <td>
                <span class="badge-type"
                  [class.bg-success]="mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO')"
                  [class.bg-danger]="!(mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO'))">
                  {{ mov.tipo }}
                </span>
              </td>
              <td>
                <ion-badge color="light" mode="ios" class="method-badge">{{ mov.metodoPago || 'EFECTIVO' }}</ion-badge>
              </td>
              <td class="desc-col">{{ mov.descripcion }}</td>
              <td class="ion-text-end font-bold amount-col"
                [class.success-text]="mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO')"
                [class.danger-text]="!(mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO'))">
                {{ (mov.tipo.includes('EGRESO') || mov.tipo.includes('PAGO')) ? '-' : '+' }} {{ mov.monto | currency }}
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="mobile-list ion-hide-sm-up">
        @for (mov of movimientos; track mov) {
        <div class="mov-card">
          <div class="mov-card-header">
            <span class="mov-time">{{ mov.fecha | date:'shortTime' }}</span>
            <span class="mov-amount"
              [class.success-text]="mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO')"
              [class.danger-text]="!(mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO'))">
              {{ (mov.tipo.includes('EGRESO') || mov.tipo.includes('PAGO')) ? '-' : '+' }} {{ mov.monto | currency }}
            </span>
          </div>
          <div class="mov-card-body">
            <div class="mov-main-info">
              <span class="badge-type mini"
                [class.bg-success]="mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO')"
                [class.bg-danger]="!(mov.tipo.includes('INGRESO') || mov.tipo.includes('VENTA') || mov.tipo.includes('ABONO'))">
                {{ mov.tipo }}
              </span>
              <p class="mov-desc">{{ mov.descripcion }}</p>
            </div>
            <ion-badge color="light" mode="ios" class="method-badge-mini">{{ mov.metodoPago || 'EFECTIVO' }}</ion-badge>
          </div>
        </div>
        }
      </div>

      @if (movimientos.length === 0) {
      <div class="empty-movements">
        <ion-icon name="receipt-outline"></ion-icon>
        <p>Aún no hay movimientos en este turno</p>
      </div>
      }
    </div>
  </div>
  }
</div>