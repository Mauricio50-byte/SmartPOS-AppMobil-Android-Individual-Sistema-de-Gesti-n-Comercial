<div class="form-card">
  <h2>{{ isEditing ? 'Editar Producto' : 'Nuevo Producto' }}</h2>

  <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
    <!-- TIPO DE ITEM -->
    <div class="form-section tipo-section">
      <h3>Tipo de Producto</h3>

      <ion-item class="input-item">
        <ion-label position="stacked">Seleccione el tipo de producto *</ion-label>
        <ion-select formControlName="tipo" placeholder="Seleccionar tipo">
          <ion-select-option value="GENERAL">General</ion-select-option>
          @if (isModuleActive('ropa')) {
          <ion-select-option value="ROPA">Ropa y Accesorios</ion-select-option>
          }
          @if (isModuleActive('alimentos')) {
          <ion-select-option value="ALIMENTO">Alimentos y
            Perecederos</ion-select-option>
          }
          @if (isModuleActive('servicios')) {
          <ion-select-option value="SERVICIO">Servicios</ion-select-option>
          }
          @if (isModuleActive('farmacia')) {
          <ion-select-option value="FARMACIA">Farmacia</ion-select-option>
          }
          @if (isModuleActive('papeleria')) {
          <ion-select-option value="PAPELERIA">Papelería</ion-select-option>
          }
          @if (isModuleActive('restaurante')) {
          <ion-select-option value="RESTAURANTE">Restaurante</ion-select-option>
          }
        </ion-select>
      </ion-item>
    </div>

    <!-- IDENTIFICACIÓN -->
    <div class="form-section">
      <h3>Identificación</h3>
      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="12">
            <ion-item class="input-item">
              <ion-label position="stacked">Nombre del Producto *</ion-label>
              <ion-input formControlName="nombre" placeholder="Ej. Camisa Polo, Manzanas, Corte de Cabello"></ion-input>
            </ion-item>
            @if (productForm.get('nombre')?.touched && productForm.get('nombre')?.invalid) {
            <div class="error-msg">
              El nombre es requerido (min 3 caracteres).
            </div>
            }
          </ion-col>

          <ion-col size="10" size-sm="5">
            <ion-item class="input-item">
              <ion-label position="stacked">Categoría</ion-label>
              <ion-select formControlName="categoriaId" placeholder="Seleccionar" interface="popover">
                @for (cat of categorias; track cat.id) {
                <ion-select-option [value]="cat.id">{{ cat.nombre }}</ion-select-option>
                }
              </ion-select>
            </ion-item>
          </ion-col>
          <ion-col size="2" size-sm="1" class="ion-align-self-center">
            <ion-button fill="clear" (click)="crearNuevaCategoria()" title="Crear Categoría">
              <ion-icon name="add-circle-outline" slot="icon-only" size="large"></ion-icon>
            </ion-button>
          </ion-col>

          <ion-col size="12" size-sm="6">
            <ion-item class="input-item">
              <ion-label position="stacked">Subcategoría (Opcional)</ion-label>
              <ion-input formControlName="subcategoria" placeholder="Ej. Camisas, Rosas"></ion-input>
              <ion-note slot="helper" class="help-text">
                Clasificación secundaria.
              </ion-note>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- DESCRIPCIÓN -->
    <div class="form-section">
      <h3>Descripción</h3>
      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="12">
            <ion-item class="input-item">
              <ion-label position="stacked">Descripción</ion-label>
              <ion-textarea formControlName="descripcion" rows="3"></ion-textarea>
            </ion-item>
          </ion-col>

          <ion-col size="12">
            <ion-item class="input-item">
              <ion-label position="stacked">Imagen del Producto (Opcional)</ion-label>
              <input type="file" (change)="onFileSelected($event)" accept="image/*" #fileInput hidden>
              <ion-button expand="block" fill="outline" (click)="fileInput.click()" class="ion-margin-top">
                <ion-icon name="camera" slot="start"></ion-icon>
                Seleccionar Imagen
              </ion-button>
              @if (previewImage || productForm.get('imagen')?.value) {
              <div class="ion-margin-top ion-text-center">
                <img [src]="previewImage || productForm.get('imagen')?.value"
                  style="max-height: 200px; border-radius: 8px;">
                <ion-button fill="clear" color="danger" (click)="removeImage()">
                  <ion-icon name="trash" slot="start"></ion-icon>
                  Quitar Imagen
                </ion-button>
              </div>
              }
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- SUB-COMPONENTES POR MÓDULO -->
    @if (productForm.get('tipo')?.value === 'ROPA') {
    <app-formulario-ropa [parentForm]="productForm">
    </app-formulario-ropa>
    }

    @if (productForm.get('tipo')?.value === 'ALIMENTO') {
    <app-formulario-alimentos [parentForm]="productForm">
    </app-formulario-alimentos>
    }

    @if (productForm.get('tipo')?.value === 'SERVICIO') {
    <app-formulario-servicios [parentForm]="productForm">
    </app-formulario-servicios>
    }

    @if (productForm.get('tipo')?.value === 'FARMACIA') {
    <app-formulario-farmacia [parentForm]="productForm">
    </app-formulario-farmacia>
    }

    @if (productForm.get('tipo')?.value === 'PAPELERIA') {
    <app-formulario-papeleria [parentForm]="productForm">
    </app-formulario-papeleria>
    }

    @if (productForm.get('tipo')?.value === 'RESTAURANTE') {
    <app-formulario-restaurante [parentForm]="productForm">
    </app-formulario-restaurante>
    }

    <!-- CATEGORIZACIÓN -->
    <div class="form-section">
      <h3>Categorización</h3>
      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="12" size-sm="4">
            <ion-item class="input-item">
              <ion-label position="stacked">SKU / Código Interno</ion-label>
              <ion-input formControlName="sku" placeholder="Ej. ROP-001"></ion-input>
              <ion-button slot="end" fill="clear" (click)="generarSkuAutomatico()" title="Generar SKU Automático">
                <ion-icon name="shuffle-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-sm="4">
            <ion-item class="input-item">
              <ion-label position="stacked">Marca</ion-label>
              <ion-input formControlName="marca"></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-sm="4">
            <ion-item class="input-item">
              <ion-label position="stacked">Proveedor</ion-label>
              <ion-input formControlName="proveedor" placeholder="Nombre del proveedor"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- PRECIOS Y COSTOS -->
    <div class="form-section">
      <h3>Precios y Costos</h3>
      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="12" size-sm="3">
            <ion-item class="input-item">
              <ion-label position="stacked">Precio Costo</ion-label>
              <ion-input type="text" inputmode="numeric" formControlName="precioCosto" appNumericFormat></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-sm="3">
            <ion-item class="input-item">
              <ion-label position="stacked">Precio Venta *</ion-label>
              <ion-input type="text" inputmode="numeric" formControlName="precioVenta" appNumericFormat></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-sm="3">
            <ion-item class="input-item">
              <ion-label position="stacked">IVA (%) (Opcional)</ion-label>
              <ion-input type="number" formControlName="porcentajeIva" placeholder="0"></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-sm="3">
            <ion-item class="input-item">
              <ion-label position="stacked">Margen (%)</ion-label>
              <ion-input type="text" formControlName="margenGanancia" readonly></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- INVENTARIO -->
    @if (productForm.get('tipo')?.value !== 'SERVICIO') {
    <div class="form-section">
      <h3>Inventario</h3>
      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="12" size-sm="4">
            <ion-item class="input-item">
              <ion-label position="stacked">Stock Actual *</ion-label>
              <ion-input type="text" inputmode="numeric" formControlName="stock" appNumericFormat></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-sm="4">
            <ion-item class="input-item">
              <ion-label position="stacked">Stock Mínimo</ion-label>
              <ion-input type="text" inputmode="numeric" formControlName="stockMinimo" appNumericFormat></ion-input>
            </ion-item>
            @if (productForm.errors?.['minStockGreaterThanStock'] && (productForm.get('stockMinimo')?.touched ||
            productForm.get('stock')?.touched)) {
            <div class="error-msg">
              El stock mínimo no puede ser mayor al stock actual.
            </div>
            }
          </ion-col>
          <ion-col size="12" size-sm="4">
            <ion-item class="input-item">
              <ion-label position="stacked">Unidad de Medida</ion-label>
              <ion-input formControlName="unidadMedida" placeholder="Ej. Unidad, Kg, Paquete, Litro"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>
    }

    <!-- ESTADO -->
    <div class="form-section">
      <ion-item lines="none" class="toggle-item">
        <ion-label>Producto Activo</ion-label>
        <ion-toggle slot="end" formControlName="activo"></ion-toggle>
      </ion-item>
    </div>

    <div class="form-actions">
      <ion-button type="button" fill="outline" color="medium" (click)="onCancel()">
        Cancelar
      </ion-button>
      <ion-button type="submit" [disabled]="productForm.invalid">
        {{ isEditing ? 'Actualizar' : 'Guardar' }}
      </ion-button>
    </div>
  </form>
</div>