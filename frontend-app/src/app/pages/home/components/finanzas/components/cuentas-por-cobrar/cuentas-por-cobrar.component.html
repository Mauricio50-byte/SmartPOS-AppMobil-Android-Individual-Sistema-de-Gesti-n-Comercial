<div class="cuentas-container">
  <div class="header-section">
    <h1>Cuentas por Cobrar</h1>
    <p class="subtitle">Gestiona las deudas de tus clientes</p>
  </div>

  <div class="toolbar">
    <ion-searchbar 
      class="search-bar" 
      mode="ios" 
      placeholder="Buscar por cliente..." 
      (ionInput)="onSearchInput($event)"
      [debounce]="250">
    </ion-searchbar>
  </div>

  <div class="content-area">
    @if (loading) {
      <div class="loading-state">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Cargando deudas...</p>
      </div>
    } @else {
      @if (filteredClientes.length > 0) {
        <div class="clients-grid">
          @for (cliente of filteredClientes; track cliente.clienteId) {
            <div class="client-card">
              <div class="card-header">
                <div class="avatar-circle">
                  {{ cliente.nombre.charAt(0).toUpperCase() }}
                </div>
                <div class="client-info">
                  <h3>{{ cliente.nombre }}</h3>
                  <p class="phone" *ngIf="cliente.telefono">
                    <ion-icon name="call-outline"></ion-icon> {{ cliente.telefono }}
                  </p>
                </div>
              </div>
              
              <div class="card-body">
                <div class="debt-info">
                  <span class="label">Total Deuda</span>
                  <span class="amount">{{ cliente.totalDeuda | currency:'USD':'symbol':'1.0-0' }}</span>
                </div>
                <div class="debt-count">
                  <span class="badge">{{ cliente.deudas.length }} facturas ptes.</span>
                </div>
              </div>

              <div class="card-footer">
                <ion-button expand="block" fill="outline" shape="round" class="action-btn" (click)="verDetalleCliente(cliente)">
                  <ion-icon name="eye-outline" slot="start"></ion-icon>
                  Ver Detalle
                </ion-button>
                <ion-button expand="block" fill="solid" shape="round" class="action-btn" color="primary" (click)="abonarGeneral(cliente)">
                  <ion-icon name="wallet-outline" slot="start"></ion-icon>
                  Abonar Todo
                </ion-button>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <div class="icon-box">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
          </div>
          <h3>¡Todo al día!</h3>
          <p>No se encontraron clientes con deudas pendientes.</p>
        </div>
      }
    }
  </div>

  <!-- Modal de Detalle de Deudas -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="cerrarModal()" [initialBreakpoint]="0.9" [breakpoints]="[0, 0.5, 0.9, 1]">
    <ng-template>
      <div class="modal-wrapper">
        <ion-header class="ion-no-border">
          <ion-toolbar>
            <ion-title>
              <div class="modal-title-wrapper">
                <ion-icon name="person-circle-outline"></ion-icon>
                <span>{{ selectedCliente?.nombre }}</span>
              </div>
            </ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="cerrarModal()" color="medium">
                <ion-icon name="close-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
          <div class="modal-summary">
            <div class="summary-item total">
              <span class="label">Deuda Total</span>
              <span class="value">{{ selectedCliente?.totalDeuda | currency:'USD':'symbol':'1.0-0' }}</span>
            </div>
          </div>

          <div class="debts-list">
            <h3>Facturas Pendientes</h3>
            @if (selectedCliente?.deudas) {
              @for (deuda of selectedCliente!.deudas; track deuda.id) {
                <div class="debt-item">
                  <div class="debt-header">
                    <span class="date">{{ deuda.fechaCreacion | date:'mediumDate' }}</span>
                    <ion-badge color="warning" mode="ios">Pendiente</ion-badge>
                  </div>
                  <div class="debt-body">
                    <div class="row">
                      <span>Monto Original:</span>
                      <strong>{{ deuda.montoTotal | currency:'USD':'symbol':'1.0-0' }}</strong>
                    </div>
                    <div class="row highlight">
                      <span>Saldo Pendiente:</span>
                      <strong>{{ deuda.saldoPendiente | currency:'USD':'symbol':'1.0-0' }}</strong>
                    </div>
                  </div>
                  <div class="debt-actions">
                    <ion-button expand="block" size="small" (click)="registrarAbono(deuda)">
                      <ion-icon name="cash-outline" slot="start"></ion-icon>
                      Registrar Abono
                    </ion-button>
                  </div>
                </div>
              }
            }
          </div>
        </ion-content>
      </div>
    </ng-template>
  </ion-modal>
</div>
